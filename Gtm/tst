<script>
function receiveIVVIMessage(event) {
  var data = event.data.data;
  var videoId = event.data.videoId
  // You can use whitelist to track only events you are interested in
  var eventsWhitelist = [
      'uniquePlay',
      'contentPlay',
      
    // All ads events
      /^ad/gi,
      's1-playlist-json-loadtime',
      'replay-button-clicked',
      'recommendation-screen-shown',
      'recommendation-tile-clicked',
      
    // All social-sharing events
      /^social\-sharing/gi,
      
    // All progress events
      /\-percent$/gi,
      /\-seconds$/gi,
      
    // All error tracking events
      's1-playlist-json-loadtime',
      'error',
      /^error\-s1/gi,
    ];
 
  if (videoId && eventsWhitelist.some(function (e) { return data.type.match(e) })) {
    // UA datalayer call
    var analytics_data = {
      'event': 'video-event',
      'eventCategory': data.eventCategory,
      'eventAction': data.type,
      'eventLabel': location.href,
      'videoID': videoId,
      'videoDuration': data.duration,
      'videoTitle': data.title,
      'videoPlayerName': data.brand,
      'videoDateCreated': data.dateCreated,
      'videoAccount': data.account,
      'videoErrorDesciption': data.descriptionMessage,
      'videoCategory': data.videoCategory,
      'videoTags': data.videoTags,
      'videoFormat': data.videoFormat,
      'videoAdTag': data.descriptionAdTag,
      'videoDescription': data.description      
    }
    dataLayer.push(analytics_data);
    
    // GA4 datalayer call
    ga4_eventname = "";
    ga4_progress = "";
    ga4_ad_progress = "";
    
    // Convert UA data to GA4
    if ((data.eventCategory == "video") && (data.type == "uniquePlay")) { ga4_eventname = "video_play"; }
    if ((data.eventCategory == "video") && (data.type == "contentPlay")) { ga4_eventname = "video_start"; }
    if ((data.eventCategory == "video") && (data.type.indexOf("percent") > -1)) {
      ga4_eventname = "video_progress";
      ga4_progress = data.type.replace("-percent", "") 
    }
    if ((data.eventCategory == "video") && (data.type.indexOf("100-percent") > -1)) {
      ga4_eventname = "video_complete"; 
      ga4_progress = data.type.replace("-percent", "") 
    }
    if ((data.eventCategory == "video") && (data.type.substr(0,2) == "ad")) {
      ga4_eventname = "video_ad"; 
      ga4_ad_progress = data.type
    }    

    if ((data.eventCategory == "live") && (data.type == "uniquePlay")) { ga4_eventname = "livestream_play"; }
    if ((data.eventCategory == "live") && (data.type == "contentPlay")) { ga4_eventname = "livestream_start"; }
    if ((data.eventCategory == "live") && (data.type.indexOf("seconds") > -1)) {
      ga4_eventname = "livestream_progress";
      ga4_progress = data.type.replace("-seconds", "") 
    }    
    if ((data.eventCategory == "live") && (data.type.substr(0,2) == "ad")) {
      ga4_eventname = "livestream_ad"; 
      ga4_ad_progress = data.type
    }  
    
    if ((data.eventCategory == "podcast") && (data.type == "uniquePlay")) { ga4_eventname = "podcast_play"; }
    if ((data.eventCategory == "podcast") && (data.type == "contentPlay")) { ga4_eventname = "podcast_start"; }
    if ((data.eventCategory == "podcast") && (data.type.indexOf("percent") > -1)) {
      ga4_eventname = "podcast_progress";
      ga4_progress = data.type.replace("-percent", "") 
    }
    if ((data.eventCategory == "podcast") && (data.type.indexOf("100-percent") > -1)) {
      ga4_eventname = "podcast_complete"; 
      ga4_progress = data.type.replace("-percent", "") 
    }
    if ((data.eventCategory == "podcast") && (data.type.substr(0,2) == "ad")) {
      ga4_eventname = "podcast_ad"; 
      ga4_ad_progress = data.type
    }    
    
    // Send GA4 datalayer call
    var ga4_analytics_data = {
      'event': 'ga4-video-event',
      'event_name' : ga4_eventname,
      'videoID': videoId,
      'videoDuration': data.duration,
      'videoTitle': data.title,
      'videoPlayerName': data.brand,
      'videoDateCreated': data.dateCreated,
      'videoAccount': data.account,
      'videoErrorDesciption': data.descriptionMessage,
      'videoCategory': data.videoCategory,
      'videoTags': data.videoTags,
      'videoFormat': data.videoFormat,
      'videoAdTag': data.descriptionAdTag,
      'videoDescription': data.description,
      'videoProgress': ga4_progress,
      'mediaAdProgress': ga4_ad_progress
    }
    if (ga4_eventname != "")
    {
      dataLayer.push(ga4_analytics_data);
    }
    
  }
};
</script>